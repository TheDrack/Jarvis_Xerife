name: "üß¨ JARVIS: Homeostase e Auto-Cura"

on:
  push:
    branches: [ main ]
  pull_request_target:
    branches: [ main ]
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

jobs:
  homeostasis:
    name: "üß™ Vistoria e Auto-Cura"
    runs-on: ubuntu-latest

    steps:
      - name: üõ∞Ô∏è Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name || github.repository }}
          fetch-depth: 0

      - name: üì¶ Setup Environment (UV)
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: üîß Instalar Depend√™ncias
        run: |
          uv venv --python 3.13
          uv pip install pytest pytest-json-report pytest-cov requests sqlmodel pydantic groq python-jose[cryptography] bcrypt
          echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

      - name: üß™ Executar Pytest
        id: run_tests
        continue-on-error: true
        run: |
          uv run pytest --json-report --json-report-file=report_1.json tests/

      - name: üî¨ An√°lise de Risco (Mec√¢nico Revisionador)
        if: github.event_name == 'pull_request_target'
        id: risk_check
        run: |
          # O Mec√¢nico analisa a inten√ß√£o e o impacto
          uv run python scripts/metabolism_analyzer.py --intent "auto-evolution" --instruction "Validar autonomia de merge" --repo-path "." > analysis_result.txt
          
          if grep -q '"requires_human": true' analysis_result.txt; then
            echo "high_risk=true" >> $GITHUB_ENV
          else
            echo "high_risk=false" >> $GITHUB_ENV
          fi

      - name: ‚úÖ Auto-Merge (Autonomia Funcional)
        # Condi√ß√£o: Testes passaram E (√â o Comandante OU N√£o √© alto risco)
        if: |
          steps.run_tests.outcome == 'success' && 
          github.event.pull_request.number != null && 
          (github.event.pull_request.user.login == 'TheDrack' || env.high_risk == 'false')
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üöÄ Condi√ß√µes de seguran√ßa atingidas. Realizando Auto-Merge."
          gh pr merge "${{ github.event.pull_request.number }}" --auto --merge --repo "${{ github.repository }}"

      - name: üîß Ciclo de Cura (Se falhar)
        if: steps.run_tests.outcome == 'failure'
        id: heal_step_1
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GH_TOKEN: ${{ github.token }}
        run: |
          uv run python scripts/self_healing_mutator.py --report "report_1.json"
          
          # Se voc√™ (Comandante) quebrou, ele tenta curar sem bloquear. 
          # Se o Jarvis quebrou em √°rea cr√≠tica, ele para.
          if [ "${{ env.high_risk }}" == "true" ] && [ "${{ github.event.pull_request.user.login }}" != "TheDrack" ]; then
            echo "stop_healing=true" >> $GITHUB_ENV
          else
            git config --global user.name "Jarvis-AutoCura"
            git config --global user.email "jarvis@bot.com"
            git add .
            git commit -m "ü§ñ [Auto-Cura] Evolu√ß√£o validada"
            git push origin HEAD:${{ github.event.pull_request.head.ref }}
            uv run pytest --json-report --json-report-file=report_2.json tests/ || echo "still_failing=true" >> $GITHUB_ENV
          fi

      - name: üö® Escalonar ao Comandante
        if: always() && (env.final_failure == 'true' || env.stop_healing == 'true')
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || github.event.number }}"
          if [ -n "$PR_NUMBER" ] && [ "$PR_NUMBER" != "null" ]; then
            gh pr edit "$PR_NUMBER" --add-label "commander-review" --repo "${{ github.repository }}"
            gh pr comment "$PR_NUMBER" --repo "${{ github.repository }}" --body "## üö® INTERVEN√á√ÉO NECESS√ÅRIA
            O metabolismo detectou uma altera√ß√£o em c√≥digo cr√≠tico que exige sua valida√ß√£o manual.
            - **Risco**: Alto (DNA Sens√≠vel)"
          fi
