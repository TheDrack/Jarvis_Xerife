name: Auto Evolution Trigger

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ==================================================
  # 1. ORQUESTRAÃ‡ÃƒO: Decide se Conclui ou se Evolui
  # ==================================================
  process_evolution:
    name: "ðŸ§¬ Orquestrador de EvoluÃ§Ã£o"
    runs-on: ubuntu-latest
    outputs:
      should_evolve: ${{ steps.decide.outputs.should_evolve }}
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Instalar DependÃªncias
        run: pip install sqlmodel pydantic requests

      - name: ðŸ§  DecisÃ£o EstratÃ©gica
        id: decide
        run: |
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          python - << 'PYCODE'
          import os, sys
          try:
              from app.application.services.auto_evolution import AutoEvolutionService
              auto = AutoEvolutionService()
              
              commit_msg = os.popen("git log -1 --pretty=%B").read()
              author = os.popen("git log -1 --pretty=%an").read()
              
              # CONDIÃ‡ÃƒO DE CONCLUSÃƒO: Se o merge veio da nossa prÃ³pria mutaÃ§Ã£o
              if "[Auto-Evolution]" in commit_msg or "Jarvis-AutoEvolution" in author:
                  print("ðŸŽ¯ Detectado Merge de EvoluÃ§Ã£o. Atualizando Roadmap...")
                  # ExtraÃ­mos o contexto da missÃ£o concluÃ­da e marcamos como âœ…
                  # Isso evita que a mesma missÃ£o seja selecionada novamente
                  next_m = auto.find_next_mission_with_auto_complete()
                  if next_m:
                      auto.mark_mission_as_completed(next_m['mission']['description'])
                      print(f"âœ… MissÃ£o '{next_m['mission']['description']}' finalizada.")
                  
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write('should_evolve=false\n')
              else:
                  # CONDIÃ‡ÃƒO DE INÃCIO: Commit manual detectado, hora de evoluir
                  print("ðŸš€ Commit manual. Iniciando busca por nova missÃ£o...")
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write('should_evolve=true\n')
          except Exception as e:
              print(f"Erro na decisÃ£o: {e}")
              sys.exit(1)
          PYCODE

  # ==================================================
  # 2. ANÃLISE: Busca prÃ³xima missÃ£o se necessÃ¡rio
  # ==================================================
  find_next_mission:
    name: "ðŸŽ¯ Buscar PrÃ³xima MissÃ£o"
    needs: process_evolution
    if: needs.process_evolution.outputs.should_evolve == 'true'
    runs-on: ubuntu-latest
    outputs:
      has_mission: ${{ steps.find.outputs.has_mission }}
      mission_description: ${{ steps.find.outputs.mission_description }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Instalar DependÃªncias
        run: pip install sqlmodel pydantic requests

      - name: ðŸŽ¯ SeleÃ§Ã£o de MissÃ£o
        id: find
        run: |
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          python - << 'PYCODE'
          import os, sys, json
          try:
              from app.application.services.auto_evolution import AutoEvolutionService
              auto = AutoEvolutionService()
              next_mission = auto.find_next_mission_with_auto_complete()
              
              if next_mission:
                  m_data = next_mission['mission']
                  desc = m_data["description"].replace(chr(10), " ").replace("'", "").replace('"', "")
                  
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write('has_mission=true\n')
                      f.write(f'mission_description={desc}\n')
                  
                  with open('mission_context.txt', 'w') as f:
                      f.write(auto.get_roadmap_context(next_mission))
              else:
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write('has_mission=false\n')
          except Exception as e:
              print(f"Erro na anÃ¡lise: {e}")
              sys.exit(1)
          PYCODE
          
      - name: Upload Context
        if: steps.find.outputs.has_mission == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: mission-context
          path: mission_context.txt

  # ==================================================
  # 3. EVOLUÃ‡ÃƒO: MutaÃ§Ã£o e PR
  # ==================================================
  attempt_evolution:
    name: "ðŸ§¬ Tentar EvoluÃ§Ã£o AutÃ´noma"
    needs: find_next_mission
    if: needs.find_next_mission.outputs.has_mission == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download Context
        uses: actions/download-artifact@v4
        with:
          name: mission-context
      - name: Setup Env
        run: |
          git config --global user.name "Jarvis-AutoEvolution"
          git config --global user.email "jarvis@bot.com"
          pip install requests sqlmodel pydantic

      - name: ðŸ¤– Ciclo de MutaÃ§Ã£o
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_BODY: ${{ needs.find_next_mission.outputs.mission_description }}
        run: |
          BRANCH_NAME="auto-evolution/mission-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          
          python scripts/metabolism_mutator.py \
            --strategy "minimal_change" \
            --intent "auto-evolution-mission" \
            --impact "functional-improvement" \
            --roadmap-context "$(cat mission_context.txt)"
          
          git add -A
          if [ -z "$(git status --porcelain)" ]; then
            echo "âš ï¸ Nenhuma mudanÃ§a detectada."
            exit 0
          fi

          git commit -m "[Auto-Evolution] DNA Mutated - Awaiting CI Validation"
          git push origin "$BRANCH_NAME"
          
          SUMMARY=$(cat mutation_summary.txt 2>/dev/null || echo "DNA Mutado com sucesso.")
          
          gh pr create --title "ðŸ§¬ EvoluÃ§Ã£o: $ISSUE_BODY" \
                       --body "### âœ… MudanÃ§as Implementadas
          $SUMMARY

          ---
          *Gerado pelo sistema JARVIS.*" \
                       --base main --head "$BRANCH_NAME"
