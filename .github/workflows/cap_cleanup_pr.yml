name: Capability Governance (Freeze / Unfreeze)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Modo de execu√ß√£o (audit ou govern)"
        required: true
        default: "govern"
        type: choice
        options:
          - audit
          - govern

jobs:
  capability-governance:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install minimal dependencies
        run: |
          python -m pip install --upgrade pip
          # Depend√™ncias opcionais ‚Äî n√£o falhar se n√£o existirem
          pip install sqlmodel || true

      - name: Run Capability Lifecycle Governance
        env:
          MODE: ${{ inputs.mode }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "========================================"
          echo " Jarvis Capability Lifecycle Governance"
          echo " Mode: $MODE"
          echo "========================================"

          python scripts/architecture_and_cap_governance.py
          STATUS=$?

          echo "Exit code returned: $STATUS"

          # 0  -> OK
          if [ "$STATUS" -eq 0 ]; then
            echo "‚úì Governan√ßa est√°vel"
            exit 0
          fi

          # 10 -> Warning arquitetural (toler√°vel)
          if [ "$STATUS" -eq 10 ]; then
            echo "‚ö†Ô∏è Warning arquitetural tolerado"
            exit 0
          fi

          # 20 -> Mudan√ßas aplicadas (freeze/unfreeze)
          if [ "$STATUS" -eq 20 ]; then
            echo "üîÅ Mudan√ßas aplicadas no reposit√≥rio"

            if [ "$MODE" = "audit" ]; then
              echo "Audit mode: n√£o bloqueando pipeline"
              exit 0
            fi

            echo "Govern mode: reexecu√ß√£o necess√°ria"
            exit 1
          fi

          # Qualquer outro c√≥digo ‚Üí falha dura
          echo "‚ùå Falha inesperada"
          exit 1

      - name: Create Pull Request with governance changes
        if: failure() && inputs.mode == 'govern'
        uses: peter-evans/create-pull-request@v6
        with:
          branch: governance/capability-lifecycle
          title: "chore(governance): auto freeze/unfreeze capabilities"
          body: |
            Este PR foi gerado automaticamente pelo sistema de governan√ßa.

            A√ß√µes realizadas:
            - Descongelamento de capabilities em uso
            - Congelamento de capabilities n√£o utilizadas

            Ap√≥s o merge, reexecute o workflow para validar estado limpo.
          commit-message: "chore(governance): auto freeze/unfreeze capabilities"
          delete-branch: false
          draft: false