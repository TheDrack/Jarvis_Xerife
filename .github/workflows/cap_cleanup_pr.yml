name: Architecture & Capability Governance

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Modo de execuÃ§Ã£o"
        required: true
        default: "govern"
        type: choice
        options:
          - audit
          - govern

jobs:
  governance:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do repositÃ³rio
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar dependÃªncias mÃ­nimas
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Rodar validaÃ§Ã£o e governanÃ§a de arquitetura
        env:
          MODE: ${{ inputs.mode }}
        run: |
          python scripts/architecture_and_cap_governance.py

      - name: Upload relatÃ³rio de caps mortos
        uses: actions/upload-artifact@v4
        with:
          name: dead-caps-report
          path: dead_caps.txt
        if: always()

      - name: Criar Pull Request de governanÃ§a
        if: inputs.mode == 'govern'
        uses: peter-evans/create-pull-request@v6
        with:
          base: main
          branch: governance/capabilities
          title: "Architecture governance: capability lifecycle sync"
          body: |
            Este PR aplica **governanÃ§a automÃ¡tica de capabilities**:

            - ğŸ”¥ Ressuscita caps congelados que voltaram a ser usados
            - ğŸ§Š Congela caps realmente mortos
            - ğŸ§  Uso detectado via Nexus + anÃ¡lise global
            - ğŸ›¡ï¸ Arquitetura validada antes da mutaÃ§Ã£o
            - ğŸš« Core, Scripts, Tests e GitHub ignorados

            Gerado automaticamente via GitHub Actions.
          commit-message: "chore(governance): sync capability lifecycle"
          labels: architecture,governance,tech-debt