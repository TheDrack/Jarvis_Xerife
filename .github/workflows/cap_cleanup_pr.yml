name: Architecture & Capability Governance

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Modo de execu칞칚o"
        required: true
        default: "govern"
        type: choice
        options:
          - audit
          - govern

jobs:
  governance:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do reposit칩rio
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar depend칡ncias m칤nimas
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Rodar valida칞칚o e governan칞a (arquitetura tolerante)
        env:
          MODE: ${{ inputs.mode }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python scripts/architecture_and_cap_governance.py || \
          if [ "$MODE" = "audit" ]; then exit 0; else exit 1; fi

      - name: Upload relat칩rio de caps mortos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dead-caps-report
          path: dead_caps.txt

      - name: Criar Pull Request de governan칞a
        if: inputs.mode == 'govern'
        uses: peter-evans/create-pull-request@v6
        with:
          base: main
          branch: governance/capabilities
          title: "Architecture governance: capability lifecycle sync"
          body: |
            Governan칞a autom치tica aplicada:

            - 游븱 Congela capabilities n칚o utilizadas
            - 游댠 Ressuscita caps que voltaram a ser chamadas
            - 游 An치lise Nexus-aware
            - 丘멆잺 Smoke test arquitetural tolerante a infra
          commit-message: "chore(governance): sync capability lifecycle"