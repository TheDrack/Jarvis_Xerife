name: Jarvis Code Fixer

# Workflow disparado via repository_dispatch com event_type 'auto_fix'
# Este workflow permite que o Jarvis aplique auto-corre√ß√µes no c√≥digo

on:
  repository_dispatch:
    types: [auto_fix]

jobs:
  apply-fix:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        # Checkout com token para permitir push
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    
    - name: Set up uv
      uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true
    
    - name: Create virtual environment
      run: uv venv --python 3.13
    
    - name: Extract payload data
      id: payload
      run: |
        echo "issue_title=${{ github.event.client_payload.issue_title }}" >> $GITHUB_OUTPUT
        echo "file_path=${{ github.event.client_payload.file_path }}" >> $GITHUB_OUTPUT
        echo "test_command=${{ github.event.client_payload.test_command }}" >> $GITHUB_OUTPUT
        # Sanitize branch name (remove special chars, spaces, etc)
        BRANCH_NAME=$(echo "jarvis/auto-fix-${{ github.event.client_payload.issue_title }}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | cut -c1-50)
        echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
    
    - name: Create new branch
      run: |
        git config user.name "Jarvis Bot"
        git config user.email "jarvis@thedrack.dev"
        git checkout -b ${{ steps.payload.outputs.branch_name }}
    
    - name: Apply fix code
      run: |
        # Decode base64 fix_code from payload and write to file
        echo "${{ github.event.client_payload.fix_code }}" | base64 -d > "${{ steps.payload.outputs.file_path }}"
        
        # Verify file was written
        if [ -f "${{ steps.payload.outputs.file_path }}" ]; then
          echo "‚úÖ Fix applied to ${{ steps.payload.outputs.file_path }}"
          echo "File contents:"
          cat "${{ steps.payload.outputs.file_path }}"
        else
          echo "‚ùå Failed to apply fix to ${{ steps.payload.outputs.file_path }}"
          exit 1
        fi
    
    - name: Install Dependencies
      run: |
        # Install dependencies similar to the test workflow
        uv pip install bcrypt==4.0.1
        uv pip install passlib[bcrypt]==1.7.4
        uv pip install fastapi uvicorn httpx pydantic pydantic-settings python-dotenv 
        uv pip install google-generativeai python-jose[cryptography] python-multipart
        uv pip install tiktoken groq
        uv pip install sqlmodel
        uv pip install pytest pytest-cov mock
        uv pip install pyperclip==1.8.2
        
        # Install from requirements if exists
        if [ -d requirements ]; then uv pip install -r requirements/core.txt || true; fi
    
    - name: Run Tests
      id: tests
      run: |
        export PYTHONPATH=$PYTHONPATH:$(pwd)
        
        # Run the specific test command from payload, or default to pytest
        if [ -n "${{ steps.payload.outputs.test_command }}" ]; then
          uv run ${{ steps.payload.outputs.test_command }}
        else
          uv run pytest -W ignore::DeprecationWarning --cov=app tests/
        fi
    
    - name: Commit and Push
      if: success()
      run: |
        git add "${{ steps.payload.outputs.file_path }}"
        git commit -m "ü§ñ Jarvis auto-fix: ${{ steps.payload.outputs.issue_title }}"
        git push -u origin ${{ steps.payload.outputs.branch_name }}
    
    - name: Create Pull Request
      if: success()
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh pr create \
          --title "ü§ñ Auto-fix: ${{ steps.payload.outputs.issue_title }}" \
          --body "## Jarvis Auto-Fix

        This PR was automatically generated by Jarvis to fix a detected issue.

        **Issue:** ${{ steps.payload.outputs.issue_title }}
        **File Modified:** ${{ steps.payload.outputs.file_path }}

        ### What was fixed
        Jarvis detected a critical error in production and formulated this fix automatically.

        ### Tests
        ‚úÖ All tests passed in the CI pipeline.

        ---
        ü§ñ Generated by Jarvis Self-Healing System" \
          --label "auto-fix,jarvis" \
          --assignee "TheDrack"
