name: "ğŸ§¬ JARVIS: Self Healing V3"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # Permite rodar manualmente no botÃ£o "Run workflow"
  workflow_dispatch: 
  # Tenta ouvir outros workflows
  workflow_run:
    workflows: ["*"]
    types: [completed]

jobs:
  homeostasis:
    name: "ğŸ§ª Vistoria e Auto-Cura"
    # SÃ³ nÃ£o roda se o commit for da prÃ³pria auto-cura
    if: "!contains(github.event.head_commit.message, '[Auto-Cura]')"
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›°ï¸ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GIT_PAT }}

      - name: ğŸ“¦ Setup UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: '3.11'

      - name: ğŸ”§ InstalaÃ§Ã£o Flash do DNA
        run: |
          uv venv --clear --python 3.11
          # InstalaÃ§Ã£o em bloco Ãºnico para evitar conflitos de versÃ£o
          uv pip install pytest pytest-json-report pytest-cov sqlmodel groq requests python-dotenv \
                         fastapi[all] pydantic-settings cryptography python-jose[cryptography] \
                         pandas numpy scikit-learn pytest-asyncio pyttsx3 pyautogui pyperclip \
                         httpx python-multipart passlib[bcrypt] bcrypt
          echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

      - name: ğŸ”„ Ciclo de ExecuÃ§Ã£o
        id: healing_process
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          PYTHONPATH: "."
        run: |
          # Gera o relatÃ³rio. Se der erro na coleta, o JSON ainda Ã© gerado com a chave 'errors'
          uv run pytest --json-report --json-report-file=report.json || true
          
          # VerificaÃ§Ã£o robusta de erros no JSON
          if [ -f report.json ]; then
            FAILED=$(jq '.summary.failed // 0' report.json)
            ERRORS=$(jq '.summary.errors // 0' report.json)
            TOTAL=$((FAILED + ERRORS))
            
            if [ "$TOTAL" -gt 0 ]; then
              echo "ğŸš¨ Problemas detectados: $TOTAL. Chamando Healer..."
              uv run python scripts/jarvis_healer.py --report report.json
              
              echo "ğŸ”„ Revalidando..."
              uv run pytest --json-report --json-report-file=report_final.json || true
              
              FINAL_ERRORS=$(jq '(.summary.failed // 0) + (.summary.errors // 0)' report_final.json)
              if [ "$FINAL_ERRORS" -eq 0 ]; then
                echo "final_status=true" >> $GITHUB_OUTPUT
                echo "healed=true" >> $GITHUB_OUTPUT
              else
                echo "final_status=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "âœ… Tudo limpo."
              echo "final_status=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Erro crÃ­tico: report.json nÃ£o foi gerado."
            exit 1
          fi

      - name: ğŸ§¬ Commit Auto-Cura
        if: steps.healing_process.outputs.healed == 'true'
        run: |
          git config --local user.email "jarvis@simbiose.ai"
          git config --local user.name "ğŸ§¬ JARVIS Homeostase"
          git add .
          git commit -m "[Auto-Cura] CorreÃ§Ã£o automÃ¡tica de DNA"
          git push

      - name: ğŸš¨ Falha Final
        if: steps.healing_process.outputs.final_status == 'false'
        run: exit 1
