name: JARVIS Self Healing V3

on:
  pull_request:
    branches: [main, master, develop]
  workflow_run:
    workflows: ["*"]
    types: [completed]
  workflow_dispatch:

jobs:
  auto_bypass:
    name: Verificacao de Gatilho
    runs-on: ubuntu-latest
    if: github.event.workflow_run.name == 'JARVIS Self Healing V3'
    steps:
      - name: Bypass
        run: exit 0

  homeostasis:
    name: Vistoria e Auto-Cura
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'pull_request' || 
      (github.event.workflow_run.conclusion == 'failure' && 
      github.event.workflow_run.name != 'JARVIS Self Healing V3')
    
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GIT_PAT }}

      - name: Setup UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: '3.11'

      - name: DNA Install
        run: |
          uv venv --clear --python 3.11
          uv pip install pytest pytest-json-report groq requests autopep8 python-dotenv

      - name: Recovery Mode
        if: github.event_name == 'workflow_run'
        id: recover_logic
        run: |
          STABLE_COMMIT=$(git rev-parse ${{ github.event.workflow_run.head_sha }}^)
          BRANCH_NAME="jarvis/recovery-${{ github.run_id }}"
          git checkout -b $BRANCH_NAME $STABLE_COMMIT
          echo "target_branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Healing Cycle
        id: healing_process
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          PYTHONPATH: "."
        run: |
          uv run pytest --json-report --json-report-file=report.json > pytest_log.txt 2>&1 || true
          uv run python scripts/jarvis_healer.py --report report.json --log pytest_log.txt
          uv run pytest --json-report --json-report-file=report_final.json > final_log.txt 2>&1 || true
          
          if ! grep -qE "ERRORS|failed|IndentationError" final_log.txt; then
             echo "status=success" >> $GITHUB_OUTPUT
          else
             echo "status=failed" >> $GITHUB_OUTPUT
             exit 1
          fi

      - name: Commit and Merge PR
        if: always() && github.event_name == 'pull_request' && steps.healing_process.outputs.status == 'success'
        env:
          GH_TOKEN: ${{ secrets.GIT_PAT }}
        run: |
          git config user.name "JARVIS"
          git config user.email "jarvis@simbiose.ai"
          git add .
          if ! git diff --staged --quiet; then
            git commit -m "chore: auto-cura integridade"
            git push origin HEAD:${{ github.head_ref }}
          fi
          gh pr merge ${{ github.event.pull_request.number }} --auto --merge || gh pr merge ${{ github.event.pull_request.number }} --merge --admin

      - name: Recovery PR
        if: always() && github.event_name == 'workflow_run' && steps.healing_process.outputs.status == 'success'
        env:
          GH_TOKEN: ${{ secrets.GIT_PAT }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          git config user.name "JARVIS"
          git config user.email "jarvis@simbiose.ai"
          git add .
          git commit -m "fix: restauração estável"
          git push origin ${{ steps.recover_logic.outputs.target_branch }}
          
          RESUMO=$(uv run python -c "
          import os, requests
          try:
              log = open('pytest_log.txt').read()[:1500]
              resp = requests.post('https://api.groq.com/openai/v1/chat/completions', 
                headers={'Authorization': f'Bearer {os.getenv(\"GROQ_API_KEY\")}'},
                json={'model': 'llama-3.3-70b-versatile', 'messages': [{'role': 'user', 'content': f'Resuma em português o erro: {log}'}]})
              print(resp.json()['choices'][0]['message']['content'])
          except:
              print('Auto-cura aplicada.')
          ")

          PR_URL=$(gh pr create --title "JARVIS Recuperação: ${{ github.event.workflow_run.name }}" \
            --body "Diagnóstico: $RESUMO" \
            --head ${{ steps.recover_logic.outputs.target_branch }} \
            --base main)
          
          gh pr merge $PR_URL --auto --merge || gh pr merge $PR_URL --merge --admin
