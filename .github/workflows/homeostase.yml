name: "üß¨ JARVIS: Self Healing V3"

on:
  pull_request:
    branches: [ main, master, develop ]
  workflow_run:
    workflows: ["*"]
    types: [completed]
  workflow_dispatch:

jobs:
  homeostasis:
    name: "üß™ Vistoria e Auto-Cura"
    # Executa se for PR OU se for uma falha de workflow (exceto ele mesmo)
    if: >
      github.event_name == 'pull_request' || 
      (github.event.workflow_run.conclusion == 'failure' && github.event.workflow_run.name != 'üß¨ JARVIS: Self Healing V3')
    
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: üõ∞Ô∏è Checkout (Full History)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üì¶ Setup UV & Python
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: '3.11'

      - name: üîß Instala√ß√£o do DNA
        run: |
          uv venv --clear --python 3.11
          uv pip install pytest pytest-json-report groq requests python-dotenv fastapi[all] pydantic-settings
          # Adicione aqui demais depend√™ncias se necess√°rio

      - name: üîç L√≥gica de Recupera√ß√£o (Workflow Failure)
        if: github.event_name == 'workflow_run'
        id: recover_logic
        run: |
          echo "‚ö†Ô∏è Falha detectada no workflow: ${{ github.event.workflow_run.name }}"
          
          # 1. Identificar commit problem√°tico e anterior
          BAD_COMMIT=${{ github.event.workflow_run.head_sha }}
          STABLE_COMMIT=$(git rev-parse $BAD_COMMIT^)
          
          # 2. Criar branch de reparo baseada no commit anterior (Rollback Seguro)
          BRANCH_NAME="jarvis/fix-${{ github.event.workflow_run.run_number }}"
          git checkout -b $BRANCH_NAME $STABLE_COMMIT
          
          # 3. Trazer os arquivos que falharam para tentativa de corre√ß√£o
          # Aqui voc√™ pode customizar para buscar logs via API do GitHub se necess√°rio
          echo "target_branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "mode=recovery" >> $GITHUB_OUTPUT

      - name: üîÑ Ciclo de Execu√ß√£o e Auto-Cura
        id: healing_process
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          echo "üß™ Iniciando Diagn√≥stico..."
          uv run pytest --json-report --json-report-file=report.json > pytest_log.txt 2>&1 || true
          
          if grep -qE "ERRORS|failed|IndentationError" pytest_log.txt; then
            echo "üö® Anomalias detectadas. Iniciando jarvis_healer.py..."
            uv run python scripts/jarvis_healer.py --report report.json --log pytest_log.txt
            
            # Revalida√ß√£o
            uv run pytest --json-report --json-report-file=report_final.json > final_log.txt 2>&1 || true
            if ! grep -qE "ERRORS|failed" final_log.txt; then
              echo "healed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚úÖ Tudo operacional."
          fi

      - name: üõ†Ô∏è Aplicar Corre√ß√µes (PR Mode)
        if: github.event_name == 'pull_request' && steps.healing_process.outputs.healed == 'true'
        run: |
          git config user.name "üß¨ JARVIS Homeostase"
          git config user.email "jarvis@simbiose.ai"
          git add .
          git commit -m "[Auto-Cura] Corre√ß√µes autom√°ticas aplicadas na PR"
          git push

      - name: üöÄ Criar PR de Reparo (Recovery Mode)
        if: github.event_name == 'workflow_run' && steps.recover_logic.outputs.mode == 'recovery'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "üß¨ JARVIS Homeostase"
          git config user.email "jarvis@simbiose.ai"
          git add .
          git commit -m "fix: Reparo autom√°tico para falha no workflow ${{ github.event.workflow_run.name }}"
          git push origin ${{ steps.recover_logic.outputs.target_branch }}
          
          gh pr create --title "üß¨ [Auto-Cura] Reset & Fix: ${{ github.event.workflow_run.name }}" \
            --body "### ‚ö†Ô∏è Falha Detectada
            **Workflow:** ${{ github.event.workflow_run.name }}
            **Log Original:** ${{ github.event.workflow_run.html_url }}
            
            **A√ß√£o Realizada:**
            1. O c√≥digo foi revertido para o estado est√°vel anterior.
            2. O protocolo de auto-cura foi aplicado sobre a base est√°vel para prevenir reincid√™ncia.
            3. Esta PR isola a falha para revis√£o humana." \
            --head ${{ steps.recover_logic.outputs.target_branch }} \
            --base main
