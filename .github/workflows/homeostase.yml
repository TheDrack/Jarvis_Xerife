name: "ğŸ§¬ JARVIS: Homeostase e Auto-Cura V2"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # Ajuste do Gatilho: Escuta a conclusÃ£o de QUALQUER workflow do repositÃ³rio
  workflow_run:
    workflows: ["*"] 
    types: [completed]

jobs:
  homeostasis:
    name: "ğŸ§ª Vistoria e Auto-Cura"
    # SÃ³ executa se:
    # 1. NÃ£o for um commit de auto-cura (evita loop)
    # 2. Se vier de um workflow_run, o workflow anterior DEVE ter falhado
    if: |
      !contains(github.event.head_commit.message, '[Auto-Cura]') &&
      (github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'failure')
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›°ï¸ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GIT_PAT }}
          ref: ${{ github.event.pull_request.head.ref || github.ref }}

      - name: ğŸ“¦ Setup UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: '3.11'

      - name: ğŸ”§ InstalaÃ§Ã£o do DNA (DependÃªncias Completas)
        run: |
          uv venv --clear --python 3.11
          # Adicionadas todas as bibliotecas que causaram ModuleNotFoundError nos seus logs
          uv pip install pytest pytest-json-report pytest-cov sqlmodel groq requests python-dotenv \
                         fastapi[all] pydantic-settings cryptography python-jose[cryptography] \
                         pandas numpy scikit-learn pytest-asyncio pyttsx3 pyautogui pyperclip \
                         httpx python-multipart passlib[bcrypt] bcrypt
          echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

      - name: ğŸ”„ Ciclo de Testes e Auto-Cura
        id: healing_process
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          PYTHONPATH: "."
        run: |
          echo "ğŸ§ª Iniciando bateria de testes e coleta..."
          # Roda o pytest gerando o relatÃ³rio mesmo em caso de erro catastrÃ³fico
          uv run pytest --json-report --json-report-file=report.json || true
          
          # Detecta Falhas (Testes que rodaram e falharam) e Erros (Falhas de import/coleÃ§Ã£o)
          FAILED=$(jq '.summary.failed // 0' report.json)
          ERRORS=$(jq '.summary.errors // 0' report.json)
          TOTAL_ISSUES=$((FAILED + ERRORS))
          
          if [ -f report.json ] && [ "$TOTAL_ISSUES" -gt 0 ]; then
            echo "ğŸš¨ Problemas detectados ($TOTAL_ISSUES). Ativando scripts/jarvis_healer.py..."
            
            # Executa a cura passando o relatÃ³rio de erros
            uv run python scripts/jarvis_healer.py --report report.json
            
            echo "ğŸ”„ Revalidando integridade pÃ³s-cura..."
            uv run pytest --json-report --json-report-file=report_final.json || true
            
            FINAL_ISSUES=$(jq '(.summary.failed // 0) + (.summary.errors // 0)' report_final.json)
            if [ "$FINAL_ISSUES" -eq 0 ]; then
               echo "âœ… Cura bem sucedida!"
               echo "final_status=true" >> $GITHUB_OUTPUT
               echo "healed=true" >> $GITHUB_OUTPUT
            else
               echo "âŒ Cura insuficiente. DNA instÃ¡vel."
               echo "final_status=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âœ… DNA Ã­ntegro. Homeostase mantida."
            echo "final_status=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ§¬ Commitar Reparo
        if: steps.healing_process.outputs.healed == 'true'
        run: |
          git config --local user.email "jarvis@simbiose.ai"
          git config --local user.name "ğŸ§¬ JARVIS Homeostase"
          git add .
          git commit -m "[Auto-Cura] CorreÃ§Ã£o estrutural e de DNA aplicada"
          git push

      - name: âœ… Auto-Merge
        if: steps.healing_process.outputs.final_status == 'true' && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GIT_PAT }}
        run: |
          echo "ğŸ«¡ Homeostase validada. Realizando merge automÃ¡tico..."
          gh pr merge ${{ github.event.pull_request.number }} --merge --delete-branch --admin || \
          gh pr merge ${{ github.event.pull_request.number }} --merge --delete-branch

      - name: ğŸš¨ EscalaÃ§Ã£o Final
        if: steps.healing_process.outputs.final_status == 'false'
        run: |
          echo "ğŸš¨ Erro crÃ­tico: O sistema nÃ£o conseguiu se auto-reparar."
          exit 1
