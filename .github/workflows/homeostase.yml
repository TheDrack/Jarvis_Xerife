name: "ðŸ§¬ JARVIS: Self Healing V3"

on:
  workflow_run:
    workflows: ["*"] # Monitora todos os workflows do repositÃ³rio
    types:
      - completed
  workflow_dispatch: 

jobs:
  homeostasis:
    name: "ðŸ§ª Vistoria e Auto-Cura"
    # CondiÃ§Ã£o corrigida e alinhada
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.name != 'ðŸ§¬ JARVIS: Self Healing V3'
    
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do CÃ³digo
        uses: actions/checkout@v4

      - name: Log de Falha Detectada
        run: |
          echo "âš ï¸ Falha detectada no workflow: ${{ github.event.workflow_run.name }}"
          echo "ðŸ”— URL da falha: ${{ github.event.workflow_run.html_url }}"

      - name: Executar Protocolo de Reparo
        run: |
          echo "Iniciando diagnÃ³stico e reparo automÃ¡tico..."
         
      - name: ðŸ›°ï¸ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GIT_PAT }}

      - name: ðŸ“¦ Setup UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: '3.11'

      - name: ðŸ”§ InstalaÃ§Ã£o do DNA
        run: |
          uv venv --clear --python 3.11
          uv pip install pytest pytest-json-report pytest-cov sqlmodel groq requests python-dotenv \
                         fastapi[all] pydantic-settings cryptography python-jose[cryptography] \
                         pandas numpy scikit-learn pytest-asyncio pyttsx3 pyautogui pyperclip \
                         httpx python-multipart passlib[bcrypt] bcrypt autopep8
          echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

      - name: ðŸ”„ Ciclo de ExecuÃ§Ã£o e Auto-Cura
        id: healing_process
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          PYTHONPATH: "."
        run: |
          echo "ðŸ§ª Iniciando bateria de testes..."
          uv run pytest --json-report --json-report-file=report.json > pytest_log.txt 2>&1 || true
          cat pytest_log.txt
          
          if grep -qE "ERRORS|failed|IndentationError|Interrupted" pytest_log.txt; then
            echo "ðŸš¨ Anomalias detectadas. Ativando Cura em Massa (DiretÃ³rio Capabilities)..."
            # O Healer agora vai varrer a pasta toda para evitar o erro dominÃ³
            uv run python scripts/jarvis_healer.py --report report.json --log pytest_log.txt
            
            echo "ðŸ”„ Revalidando integridade pÃ³s-cura..."
            uv run pytest --json-report --json-report-file=report_final.json > final_log.txt 2>&1 || true
            cat final_log.txt
            
            if ! grep -qE "ERRORS|failed|IndentationError" final_log.txt; then
              echo "âœ… Auto-cura bem sucedida."
              echo "healed=true" >> $GITHUB_OUTPUT
              echo "final_status=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ Falha: DNA permanece instÃ¡vel. Verifique erros de lÃ³gica alÃ©m da indentaÃ§Ã£o."
              echo "final_status=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âœ… DNA Ãntegro."
            echo "final_status=true" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ§¬ Commit dos Reparos
        if: steps.healing_process.outputs.healed == 'true'
        run: |
          git config --local user.email "jarvis@simbiose.ai"
          git config --local user.name "ðŸ§¬ JARVIS Homeostase"
          git add .
          git commit -m "[Auto-Cura] ReindentaÃ§Ã£o em massa das capabilities"
          git push

      - name: ðŸš¨ EscalaÃ§Ã£o
        if: steps.healing_process.outputs.final_status == 'false'
        run: exit 1
