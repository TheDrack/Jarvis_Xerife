name: "üß¨ JARVIS: Homeostase e Auto-Cura V2"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: 
  workflow_run:
    workflows: ["*"]
    types: [completed]

jobs:
  homeostasis:
    name: "üß™ Vistoria e Auto-Cura"
    if: "!contains(github.event.head_commit.message, '[Auto-Cura]')"
    runs-on: ubuntu-latest

    steps:
      - name: üõ∞Ô∏è Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GIT_PAT }}

      - name: üì¶ Setup UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: '3.11'

      - name: üîß Instala√ß√£o do DNA
        run: |
          uv venv --clear --python 3.11
          uv pip install pytest pytest-json-report pytest-cov sqlmodel groq requests python-dotenv \
                         fastapi[all] pydantic-settings cryptography python-jose[cryptography] \
                         pandas numpy scikit-learn pytest-asyncio pyttsx3 pyautogui pyperclip \
                         httpx python-multipart passlib[bcrypt] bcrypt
          echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

      - name: üíâ Vacina Preventiva (Sanitiza√ß√£o)
        run: |
          echo "üíâ Removendo identa√ß√µes inesperadas em arquivos core..."
          # Remove espa√ßos/tabs no in√≠cio de linhas que come√ßam com def ou class
          find app/domain/capabilities/ -name "*.py" -exec sed -i 's/^[[:space:]]\+\(def \)/\1/' {} +
          find app/domain/capabilities/ -name "*.py" -exec sed -i 's/^[[:space:]]\+\(class \)/\1/' {} +

      - name: üîÑ Ciclo de Execu√ß√£o e Auto-Cura
        id: healing_process
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          PYTHONPATH: "."
        run: |
          echo "üß™ Iniciando testes..."
          uv run pytest --json-report --json-report-file=report.json || true
          
          if [ -f report.json ]; then
            # L√≥gica robusta: detecta falhas, erros de sum√°rio e erros de cole√ß√£o (lista errors)
            HAS_ERRORS=$(jq 'if ((.summary.errors // 0) > 0) or ((.errors | length) > 0) or ((.summary.failed // 0) > 0) then "true" else "false" end' report.json)
            
            if [ "$HAS_ERRORS" == '"true"' ]; then
              echo "üö® Anomalias detectadas. Ativando Protocolo de Cura..."
              uv run python scripts/jarvis_healer.py --report report.json
              
              echo "üîÑ Revalidando integridade..."
              uv run pytest --json-report --json-report-file=report_final.json || true
              
              STILL_HAS_ERRORS=$(jq 'if ((.summary.errors // 0) > 0) or ((.errors | length) > 0) or ((.summary.failed // 0) > 0) then "true" else "false" end' report_final.json)
              
              if [ "$STILL_HAS_ERRORS" == '"false"' ]; then
                echo "‚úÖ Auto-cura bem sucedida."
                echo "final_status=true" >> $GITHUB_OUTPUT
                echo "healed=true" >> $GITHUB_OUTPUT
              else
                echo "‚ùå Falha cr√≠tica: DNA permanece inst√°vel."
                echo "final_status=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "‚úÖ DNA √çntegro."
              echo "final_status=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå Erro Fatal: Relat√≥rio n√£o gerado."
            exit 1
          fi

      - name: üß¨ Commit dos Reparos
        if: steps.healing_process.outputs.healed == 'true'
        run: |
          git config --local user.email "jarvis@simbiose.ai"
          git config --local user.name "üß¨ JARVIS Homeostase"
          git add .
          git commit -m "[Auto-Cura] Corre√ß√£o de DNA e estrutura aplicada"
          git push

      - name: ‚úÖ Auto-Merge
        if: steps.healing_process.outputs.final_status == 'true' && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GIT_PAT }}
        run: |
          gh pr merge ${{ github.event.pull_request.number }} --merge --delete-branch --admin || \
          gh pr merge ${{ github.event.pull_request.number }} --merge --delete-branch

      - name: üö® Escala√ß√£o
        if: steps.healing_process.outputs.final_status == 'false'
        run: exit 1
