name: ğŸ–¥ï¸ Build and Release Jarvis Installer

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: ğŸ›°ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ github.token }}

      - name: ğŸ“¦ Set up uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: ğŸ Set up Python
        run: uv python install 3.13

      - name: ğŸ”§ Install dependencies
        run: |
          uv venv
          # DependÃªncias explÃ­citas + projeto
          uv pip install pyinstaller bcrypt==4.0.1 passlib[bcrypt]==1.7.4
          if (Test-Path "requirements.txt") { uv pip install -r requirements.txt }
        shell: pwsh

      - name: ğŸ” Debug Path (Verify main.py existence)
        run: |
          if (Test-Path "app/application/services/main.py") {
            Write-Host "[OK] main.py found at app/application/services/main.py"
          } else {
            Write-Host "[ERROR] main.py NOT found! Check folder structure."
            ls -Recurse
            exit 1
          }
        shell: pwsh

      # ğŸ”‘ AQUI entra o mesmo padrÃ£o do pipeline funcional
      - name: ğŸ§  Run JARVIS Pipeline (Build Installer)
        env:
          PIPELINE: build_installer
          PIPELINE_STRICT: "true"

        run: |
          Write-Host "ğŸ“ Workspace: $(Get-Location)"
          Write-Host "ğŸ Python:"
          uv run python --version
          Write-Host "ğŸ§  Pipeline selecionado: $env:PIPELINE"

          # Garante que o pacote 'app' Ã© resolvÃ­vel
          $env:PYTHONPATH = "$(Get-Location)"

          $PIPELINE_RUNNER = "app/runtime/pipeline_runner.py"

          if (Test-Path $PIPELINE_RUNNER) {
            Write-Host "ğŸš€ Executando pipeline JARVIS..."
            uv run python $PIPELINE_RUNNER
            Write-Host "âœ… Pipeline executado com sucesso."
          } else {
            Write-Host "âŒ Erro: pipeline_runner.py nÃ£o encontrado em app/runtime/"
            exit 1
          }

      - name: âœ… Verify build
        run: |
          if (Test-Path "dist\Jarvis_Installer.exe") {
            $item = Get-Item "dist\Jarvis_Installer.exe"
            Write-Host "âœ“ Executable built successfully: $($item.FullName)"
          } else {
            Write-Host "âœ— Executable not found in dist/"
            exit 1
          }
        shell: pwsh

      - name: ğŸ“¦ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Jarvis_Installer
          path: dist/Jarvis_Installer.exe
          retention-days: 30
          if-no-files-found: error
          compression-level: 6

      - name: ğŸ·ï¸ Create Release (on tag)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/Jarvis_Installer.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ github.token }}