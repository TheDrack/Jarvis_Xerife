name: "ğŸ§¬ JARVIS: Homeostase e Auto-Cura V3"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  homeostasis:
    name: "ğŸ§ª Vistoria e Auto-Cura"
    # O check [Auto-Cura] evita loops, mas permite que o reparo seja testado
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›°ï¸ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GIT_PAT }}
          ref: ${{ github.event.pull_request.head.ref || github.ref }}

      - name: ğŸ“¦ Setup UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: '3.11'

      - name: ğŸ”§ InstalaÃ§Ã£o do DNA
        run: |
          uv venv --clear --python 3.11
          uv pip install pytest pytest-json-report pytest-cov sqlmodel groq requests python-dotenv
          echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

      - name: ğŸ”„ Ciclo de Testes e DiagnÃ³stico
        id: test_phase
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          echo "ğŸ§¬ Iniciando verificaÃ§Ã£o de integridade..."
          uv run pytest --json-report --json-report-file=report.json || true
          
          if [ -f report.json ] && [ "$(jq '.summary.failed // 0' report.json)" == "0" ]; then
            echo "health=stable" >> $GITHUB_OUTPUT
            echo "âœ… DNA Ã­ntegro."
          else
            echo "health=unstable" >> $GITHUB_OUTPUT
            echo "âŒ Instabilidade detectada no DNA."
          fi

      - name: ğŸ› ï¸ Tentativa de Auto-Cura
        # SÃ³ executa se houver falha e NÃƒO for um commit que jÃ¡ Ã© de Auto-Cura
        if: steps.test_phase.outputs.health == 'unstable' && !contains(github.event.head_commit.message, '[Auto-Cura]')
        id: self_healing
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GIT_PAT: ${{ secrets.GIT_PAT }}
        run: |
          echo "ğŸ§  Invocando protocolos de reparo do JARVIS..."
          # Aqui chamamos o script de inteligÃªncia que analisarÃ¡ o report.json
          # Vamos assumir que o script se chama 'scripts/repair_dna.py'
          uv run python scripts/repair_dna.py report.json
          
          if [ $? -eq 0 ]; then
            echo "repaired=true" >> $GITHUB_OUTPUT
            echo "âœ¨ Reparo sugerido e aplicado localmente."
          else
            echo "repaired=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ JARVIS nÃ£o conseguiu auto-curar esta falha."
          fi

      - name: ğŸ§¬ Commit do Reparo
        if: steps.self_healing.outputs.repaired == 'true'
        run: |
          git config --global user.name "JARVIS [Auto-Cura]"
          git config --global user.email "jarvis@symbiotic.entity"
          git add .
          git commit -m "ğŸ§¬ [Auto-Cura] CorreÃ§Ã£o automÃ¡tica de falhas no DNA"
          git push origin ${{ github.event.pull_request.head.ref || github.ref }}
          echo "ğŸš€ Reparo enviado para re-validaÃ§Ã£o."

      - name: âœ… Auto-Merge
        if: steps.test_phase.outputs.health == 'stable' && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GIT_PAT }}
        run: |
          echo "ğŸ«¡ Vistoria concluÃ­da. Realizando integraÃ§Ã£o automÃ¡tica..."
          gh pr merge ${{ github.event.pull_request.number }} --merge --delete-branch --admin || \
          gh pr merge ${{ github.event.pull_request.number }} --merge --delete-branch

      - name: ğŸš¨ EscalaÃ§Ã£o CrÃ­tica
        # Falha se o DNA estiver instÃ¡vel e a cura falhou OU se for um loop de erro
        if: steps.test_phase.outputs.health == 'unstable' && (steps.self_healing.outputs.repaired == 'false' || contains(github.event.head_commit.message, '[Auto-Cura]'))
        run: |
          echo "ğŸš¨ Homeostase CrÃ­tica: IntervenÃ§Ã£o Humana NecessÃ¡ria."
          if [ -f report.json ]; then
            jq '.tests[] | select(.outcome == "failed") | {nodeid, message: .call.crash.message}' report.json
          fi
          exit 1
