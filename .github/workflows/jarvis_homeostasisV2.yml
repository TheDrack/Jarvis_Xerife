name: "ðŸ§¬ JARVIS: Homeostase e Auto-Cura V2"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  homeostasis:
    name: "ðŸ§ª Vistoria e Auto-Cura"
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ›°ï¸ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: ðŸ”§ InstalaÃ§Ã£o do Motor JARVIS
        run: |
          uv venv --python 3.13
          # Instalando dependÃªncias vitais detectadas nos logs de erro
          uv pip install pytest pytest-json-report pytest-cov pytest-asyncio \
                         pydantic pydantic-settings cryptography httpx \
                         sqlmodel groq python-dotenv requests
          echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

      - name: ðŸ”„ Ciclo de Cura e DecisÃ£o
        id: healing_process
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          ATTEMPT=1
          SUCCESS=false
          FINAL_MSG="Falha CrÃ­tica"

          while [ $ATTEMPT -le 2 ]; do
            echo "ðŸ§ª Tentativa $ATTEMPT..."
            
            # Executa pytest. O '|| true' garante que o script nÃ£o morra aqui se o teste falhar
            uv run pytest --json-report --json-report-file=report.json tests/ || true
            
            # Se o pytest passou (exit code 0), marcamos sucesso
            if [ $? -eq 0 ] && [ -f report.json ] && [ "$(jq '.summary.passed' report.json)" != "0" ]; then
              echo "âœ… Sistema EstÃ¡vel."
              SUCCESS=true
              FINAL_MSG="Sucesso"
              break
            fi
            
            echo "ðŸ”¬ Analisando erros (Coleta ou ExecuÃ§Ã£o)..."
            
            # Captura Erros de Coleta (os que travaram o JARVIS antes) ou Erros de Teste
            if [ -f report.json ]; then
              # Tenta pegar erros de teste, se nÃ£o houver, pega erros de coleta
              ERR_DATA=$(jq -c '.tests[] | select(.outcome=="failed" or .outcome=="error") | {id:.nodeid, m:.call.crash.message}' report.json | head -c 800)
              [ -z "$ERR_DATA" ] && ERR_DATA=$(jq -c '.collectors[] | select(.result=="error") | {id:.nodeid, m:.longrepr}' report.json | head -c 800)
            fi

            [ -z "$ERR_DATA" ] && ERR_DATA="Erro de ambiente ou dependÃªncia nÃ£o registrada no JSON."

            # MecÃ¢nico avalia o estrago
            RISK_OUT=$(uv run python scripts/metabolism_analyzer.py --intent "self-healing" --instruction "Corrigir falha" --context "LOG_ERRO: $ERR_DATA")
            
            if echo "$RISK_OUT" | grep -q '"requires_human": true'; then
              FINAL_MSG=$(echo $RISK_OUT | jq -r '.reason')
              break
            fi

            echo "ðŸ©¹ Aplicando Auto-Cura..."
            uv run python scripts/self_healing_mutator.py --report "report.json"
            
            git config --global user.name "Jarvis-AutoEvolution"
            git config --global user.email "jarvis@bot.com"
            git add -A
            git commit -m "ðŸ¤– [Auto-Cura] Tentativa #$ATTEMPT" || echo "Sem mudanÃ§as"
            
            ATTEMPT=$((ATTEMPT+1))
          done

          echo "final_status=$SUCCESS" >> $GITHUB_OUTPUT
          echo "FINAL_REASON=$FINAL_MSG" >> $GITHUB_ENV

      - name: âœ… Auto-Merge
        if: steps.healing_process.outputs.final_status == 'true' && github.event.pull_request.number != null
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event.pull_request.user.login }}" = "TheDrack" ]; then
            gh pr merge ${{ github.event.pull_request.number }} --auto --merge
          fi

      - name: ðŸš¨ EscalaÃ§Ã£o
        if: steps.healing_process.outputs.final_status == 'false' && env.FINAL_REASON != 'Sucesso'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create --title "ðŸš¨ Homeostase V2: IntervenÃ§Ã£o Requerida" --body "O sistema falhou. Motivo: ${{ env.FINAL_REASON }}"
          exit 1
