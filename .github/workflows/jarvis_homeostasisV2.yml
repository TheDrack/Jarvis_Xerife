name: "üß¨ JARVIS: Homeostase e Auto-Cura V2"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  homeostasis:
    name: "üß™ Vistoria e Auto-Cura"
    # Evita loops infinitos de commits de auto-cura ou sincroniza√ß√£o
    if: |
      (github.event_name == 'pull_request') || 
      (github.event_name == 'push' && !contains(github.event.head_commit.message, '[Auto-Cura]') && !contains(github.event.head_commit.message, '[Auto-Evolution]'))
    runs-on: ubuntu-latest

    steps:
      - name: üõ∞Ô∏è Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üì¶ Setup UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: üîß Preparar Ambiente
        run: |
          uv venv --python 3.13
          uv pip install pytest pytest-json-report requests sqlmodel pydantic groq
          echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

      - name: üîÑ Ciclo de Cura e Decis√£o
        id: healing_process
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          ATTEMPT=1
          SUCCESS=false
          REASON="Testes falharam persistentemente"

          while [ $ATTEMPT -le 2 ]; do
            echo "üß™ Tentativa de Teste $ATTEMPT..."
            
            # 1. Execu√ß√£o do Teste
            if uv run pytest --json-report --json-report-file=report.json tests/; then
              echo "‚úÖ SUCESSO: Testes aprovados."
              SUCCESS=true
              break
            fi
            
            echo "üî¨ Falha detectada. Consultando o Mec√¢nico..."
            
            # 2. Prepara√ß√£o de contexto rico para o Mec√¢nico (evita erro de 'informa√ß√£o insuficiente')
            ERROR_DATA=$(cat report.json | jq -c '.tests[] | select(.outcome == "failed") | {id: .nodeid, err: .call.crash.message}' | head -c 1200)
            SUMMARY_DATA=$(cat report.json | jq -c '.summary')
            
            RISK_OUT=$(uv run python scripts/metabolism_analyzer.py \
              --intent "self-healing" \
              --instruction "An√°lise de falha de teste" \
              --context "Summary: $SUMMARY_DATA | Failures: $ERROR_DATA")
            
            # 3. Verifica√ß√£o de Risco
            if echo "$RISK_OUT" | grep -q '"requires_human": true'; then
              REASON=$(echo $RISK_OUT | jq -r '.reason')
              echo "‚ö†Ô∏è BLOQUEIO: Mec√¢nico exige interven√ß√£o humana. Motivo: $REASON"
              SUCCESS=false
              break
            fi

            echo "ü©π Iniciando Muta√ß√£o de Cura..."
            # 4. Aplica√ß√£o da Cura
            uv run python scripts/self_healing_mutator.py --report "report.json"
            
            # 5. Commit da corre√ß√£o para a branch
            git config --global user.name "Jarvis-AutoEvolution"
            git config --global user.email "jarvis@bot.com"
            git add -A
            git commit -m "ü§ñ [Auto-Cura] Corre√ß√£o aplicada (Tentativa $ATTEMPT)" || echo "Nenhuma mudan√ßa necess√°ria"
            
            ATTEMPT=$((ATTEMPT+1))
          done

          echo "final_status=$SUCCESS" >> $GITHUB_OUTPUT
          echo "FINAL_REASON=$REASON" >> $GITHUB_ENV

      - name: ‚úÖ Finaliza√ß√£o: Auto-Merge
        # Se os testes passaram (original ou corrigido), faz o Merge se for PR sua
        if: steps.healing_process.outputs.final_status == 'true' && github.event.pull_request.number != null
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Protocolo 'Voz do Dono'
          if [ "${{ github.event.pull_request.user.login }}" = "TheDrack" ]; then
            echo "ü´° Voz do Dono confirmada. Realizando Merge Autom√°tico..."
            gh pr merge ${{ github.event.pull_request.number }} --auto --merge
          else
            echo "‚úÖ Testes OK, mas autor n√£o √© o Comandante. Aguardando revis√£o manual por seguran√ßa."
          fi

      - name: üö® Finaliza√ß√£o: Escala√ß√£o
        # Se ap√≥s 2 tentativas ou risco cr√≠tico o status for falha, abre Issue
        if: steps.healing_process.outputs.final_status == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "‚ùå Falha cr√≠tica. Notificando Comandante..."
          gh issue create --title "üö® Homeostase V2: Interven√ß√£o Requerida (@TheDrack)" \
            --body "O sistema n√£o p√¥de se auto-curar. 
            **Status:** Falha Final
            **Motivo da Reten√ß√£o:** ${{ env.FINAL_REASON }}
            
            Verifique os logs para detalhes t√©cnicos."
          exit 1
