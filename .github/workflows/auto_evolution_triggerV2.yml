name: JARVIS Integrated Evolution
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # JOB 1: A GÃŠNESE (Cria a PR de EvoluÃ§Ã£o)
  evolution_cycle:
    name: "ðŸ§¬ Ciclo de EvoluÃ§Ã£o"
    # SÃ³ roda no push direto na main (ou manual), nÃ£o em PRs
    if: github.event_name != 'pull_request' && !contains(github.event.head_commit.message, '[Auto-Evolution]')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.JARVIS_PAT }} # Essencial para disparar o prÃ³ximo Job

      - name: ðŸ“¦ Setup UV
        uses: astral-sh/setup-uv@v5

      - name: ðŸ§  Orquestrador de MissÃ£o
        id: flow
        run: |
          uv venv && uv pip install sqlmodel pydantic requests
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          uv run python - << 'PYCODE'
          import os, sys
          from app.application.services.auto_evolutionV2 import AutoEvolutionServiceV2
          try:
              auto = AutoEvolutionServiceV2()
              next_m = auto.find_next_mission()
              if next_m:
                  with open('mission_context.txt', 'w', encoding='utf-8') as f:
                      f.write(auto.get_roadmap_context(next_m))
                  print(f"::set-output name=action::evolve")
                  print(f"::set-output name=mission_desc::{next_m['id']}: {next_m['title']}")
              else:
                  print(::set-output name=action::idle")
          except Exception as e: sys.exit(1)
          PYCODE

      - name: ðŸ¤– MutaÃ§Ã£o e Abertura de PR
        if: steps.flow.outputs.action == 'evolve'
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GH_TOKEN: ${{ secrets.JARVIS_PAT }} # PAT aqui faz a PR "acordar" o prÃ³ximo job
        run: |
          git config --global user.name "Jarvis-Bot"
          git config --global user.email "jarvis@bot.com"
          
          # Crystallize & Mutate
          uv run python app/application/services/crystallization/crystallizer_engine.py
          BRANCH_NAME="auto-evolution/mission-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          
          uv run python scripts/evolution_mutator.py \
            --strategy "minimal_change" \
            --impact "functional-improvement" \
            --roadmap-context "$(cat mission_context.txt)"
          
          git add -A
          git commit -m "[Auto-Evolution] DNA Mutated: ${{ steps.flow.outputs.mission_desc }}"
          git push origin "$BRANCH_NAME"
          
          gh pr create --title "ðŸ§¬ EvoluÃ§Ã£o: ${{ steps.flow.outputs.mission_desc }}" \
                       --body "Iniciando verificaÃ§Ã£o de Homeostase..." \
                       --base main --head "$BRANCH_NAME"

  # JOB 2: A HOMEOSTASE (Roda DENTRO da PR criada acima)
  homeostasis:
    name: "ðŸ§ª Homeostase e Auto-Cura"
    # Roda apenas em Pull Requests (incluindo as criadas pelo Job 1)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ›°ï¸ Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.JARVIS_PAT }}

      - name: ðŸ“¦ Setup UV e Ambiente
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: ðŸ”§ InstalaÃ§Ã£o
        run: |
          uv venv --python 3.13
          uv pip install pytest pytest-json-report pydantic sqlmodel groq requests
          echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

      - name: ðŸ”„ Ciclo de Cura Ativa
        id: healing
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          SUCCESS=false
          for i in {1..2}; do
            uv run pytest --json-report --json-report-file=report.json tests/ || true
            if [ -f report.json ] && [ "$(jq '.summary.failed // 0' report.json)" == "0" ]; then
              SUCCESS=true && break
            fi
            uv run python scripts/self_healing_mutator.py --report "report.json"
            git config --global user.name "Jarvis-Bot"
            git config --global user.email "jarvis@bot.com"
            git add -A
            git commit -m "ðŸ¤– [Auto-Cura] EstabilizaÃ§Ã£o #$i" && git push origin ${{ github.event.pull_request.head.ref }} || echo "Sem mudanÃ§as"
          done
          echo "final_status=$SUCCESS" >> $GITHUB_OUTPUT

      - name: âœ… Auto-Merge
        if: steps.healing.outputs.final_status == 'true'
        env:
          GH_TOKEN: ${{ secrets.JARVIS_PAT }}
        run: gh pr merge ${{ github.event.pull_request.number }} --auto --merge

      - name: ðŸš¨ EscalaÃ§Ã£o
        if: steps.healing.outputs.final_status == 'false'
        run: exit 1
