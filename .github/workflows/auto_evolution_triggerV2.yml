name: JARVIS Integrated Evolution
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  evolution_cycle:
    name: "üß¨ Ciclo de Evolu√ß√£o"
    if: github.event_name != 'pull_request' && !contains(github.event.head_commit.message, '[Auto-Evolution]')
    runs-on: ubuntu-latest
    outputs:
      action: ${{ steps.flow.outputs.action }}
      pr_number: ${{ steps.create_pr.outputs.pr_number }}
      branch: ${{ steps.create_pr.outputs.branch }}
      mission_desc: ${{ steps.flow.outputs.mission_desc }}
    steps:
      - name: üõ∞Ô∏è Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.JARVIS_PAT || secrets.GITHUB_TOKEN }}

      - name: üì¶ Setup UV
        uses: astral-sh/setup-uv@v5

      - name: üß† Orquestrador e Muta√ß√£o
        id: flow
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GH_TOKEN: ${{ secrets.JARVIS_PAT || secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          uv venv --python 3.11
          uv pip install sqlmodel pydantic requests groq python-dotenv
          PY_VENV=".venv/bin/python"
          $PY_VENV - << 'PYCODE'
          import os, sys
          from app.application.services.auto_evolutionV2 import AutoEvolutionServiceV2
          try:
              auto = AutoEvolutionServiceV2()
              next_m = auto.find_next_mission()
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  if next_m:
                      with open('mission_context.txt', 'w', encoding='utf-8') as mc:
                          mc.write(auto.get_roadmap_context(next_m))
                      f.write(f"action=evolve\nmission_desc={next_m['id']}: {next_m['title']}\n")
                  else: f.write("action=idle\n")
          except Exception as e: sys.exit(1)
          PYCODE

      - name: ü§ñ Muta√ß√£o e Abertura de PR
        id: create_pr
        if: steps.flow.outputs.action == 'evolve'
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GH_TOKEN: ${{ secrets.JARVIS_PAT || secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          git config --global user.name "Jarvis-Bot"
          git config --global user.email "jarvis@bot.com"
          PY_VENV=".venv/bin/python"
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          
          # 1. Cristaliza√ß√£o
          $PY_VENV app/application/services/crystallization/crystallizer_engine.py
          
          # 2. Setup e Push Imediato (Garante checkout na Homeostase)
          BRANCH_NAME="auto-evolution/mission-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          git commit --allow-empty -m "üß¨ [Auto-Evolution] Iniciando Miss√£o: ${{ steps.flow.outputs.mission_desc }}"
          git push origin "$BRANCH_NAME"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # 3. Muta√ß√£o (DNA Injection)
          if ! $PY_VENV scripts/evolution_mutator.py \
            --strategy "minimal_change" \
            --intent "auto-evolution-mission" \
            --impact "functional-improvement" \
            --roadmap-context "$(cat mission_context.txt)"; then
              echo "‚ùå Falha no mutator, a Homeostase assumir√° o controle."
              exit 1
          fi

          git add -A
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "[Auto-Evolution] DNA Mutated: ${{ steps.flow.outputs.mission_desc }}"
            git push origin "$BRANCH_NAME"
            PR_URL=$(gh pr create --title "üß¨ Evolu√ß√£o: ${{ steps.flow.outputs.mission_desc }}" \
                         --body "Auto-Cura em andamento." --base main --head "$BRANCH_NAME")
            echo "pr_number=$(echo $PR_URL | awk -F'/' '{print $6}')" >> $GITHUB_OUTPUT
          fi
