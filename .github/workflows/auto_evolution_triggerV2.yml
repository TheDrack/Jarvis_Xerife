name: JARVIS Integrated Evolution
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # JOB 1: A G√äNESE
  evolution_cycle:
    name: "üß¨ Ciclo de Evolu√ß√£o"
    if: github.event_name != 'pull_request' && !contains(github.event.head_commit.message, '[Auto-Evolution]')
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
    steps:
      - name: üõ∞Ô∏è Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.JARVIS_PAT || secrets.GITHUB_TOKEN }}

      - name: üì¶ Setup UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: üß† Orquestrador e Muta√ß√£o
        id: flow
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GH_TOKEN: ${{ secrets.JARVIS_PAT || secrets.GITHUB_TOKEN }}
        run: |
          # 1. Setup do Ambiente Unificado
          uv venv --python 3.11
          uv pip install sqlmodel pydantic requests groq python-dotenv
          source .venv/bin/activate
          export PYTHONPATH="${{ github.workspace }}"

          # 2. Identifica√ß√£o da Miss√£o
          python - << 'PYCODE'
          import os, sys
          from app.application.services.auto_evolutionV2 import AutoEvolutionServiceV2
          try:
              auto = AutoEvolutionServiceV2()
              next_m = auto.find_next_mission()
              if next_m:
                  with open('mission_context.txt', 'w', encoding='utf-8') as mc:
                      mc.write(auto.get_roadmap_context(next_m))
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f"action=evolve\nmission_desc={next_m['id']}: {next_m['title']}\n")
              else:
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write("action=idle\n")
          except Exception as e:
              print(f"‚ùå Erro no Orquestrador: {e}"); sys.exit(1)
          PYCODE

          # 3. Execu√ß√£o da Evolu√ß√£o (Apenas se houver miss√£o)
          if [ "${{ steps.flow.outputs.action }}" == "evolve" ]; then
            git config --global user.name "Jarvis-Bot"
            git config --global user.email "jarvis@bot.com"

            # Cristaliza√ß√£o
            python app/application/services/crystallization/crystallizer_engine.py

            # Setup de Branch
            BRANCH_NAME="auto-evolution/mission-$(date +%s)"
            git checkout -b "$BRANCH_NAME"

            # Muta√ß√£o com Verbose para Debug
            python scripts/evolution_mutator.py \
              --strategy "minimal_change" \
              --intent "auto-evolution-mission" \
              --impact "functional-improvement" \
              --roadmap-context "$(cat mission_context.txt)"

            # Commit e PR
            git add -A
            if [ -n "$(git status --porcelain)" ]; then
              git commit -m "[Auto-Evolution] DNA Mutated: ${{ steps.flow.outputs.mission_desc }}"
              git push origin "$BRANCH_NAME"
              gh pr create --title "üß¨ Evolu√ß√£o: ${{ steps.flow.outputs.mission_desc }}" \
                           --body "Ciclo autom√°tico JARVIS. Iniciando valida√ß√£o de Homeostase." \
                           --base main --head "$BRANCH_NAME"
            fi
          fi

  # JOB 2: A HOMEOSTASE
  homeostasis:
    name: "üß™ Homeostase e Auto-Cura"
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
    steps:
      - name: üõ∞Ô∏è Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.JARVIS_PAT || secrets.GITHUB_TOKEN }}

      - name: üì¶ Setup UV
        uses: astral-sh/setup-uv@v5

      - name: üîß Instala√ß√£o e Ciclo de Cura
        id: healing
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GH_TOKEN: ${{ secrets.JARVIS_PAT || secrets.GITHUB_TOKEN }}
        run: |
          uv venv --python 3.13
          uv pip install pytest pytest-json-report pydantic sqlmodel groq requests python-dotenv
          source .venv/bin/activate
          export PYTHONPATH="${{ github.workspace }}"
          
          SUCCESS=false
          for i in {1..2}; do
            echo "üß™ Tentativa de Estabiliza√ß√£o $i..."
            pytest --json-report --json-report-file=report.json tests/ || true
            
            if [ -f report.json ] && [ "$(jq '.summary.failed // 0' report.json)" == "0" ]; then
              SUCCESS=true && break
            fi
            
            python scripts/self_healing_mutator.py --report "report.json"
            git config --global user.name "Jarvis-Bot"
            git config --global user.email "jarvis@bot.com"
            git add -A
            if [ -n "$(git status --porcelain)" ]; then
              git commit -m "ü§ñ [Auto-Cura] Estabiliza√ß√£o #$i"
              git push origin ${{ github.event.pull_request.head.ref }}
            fi
          done
          echo "final_status=$SUCCESS" >> $GITHUB_OUTPUT

      - name: ‚úÖ Consolida√ß√£o
        if: steps.healing.outputs.final_status == 'true'
        env:
          GH_TOKEN: ${{ secrets.JARVIS_PAT || secrets.GITHUB_TOKEN }}
        run: gh pr merge ${{ github.event.pull_request.number }} --auto --merge
