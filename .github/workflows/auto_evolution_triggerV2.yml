name: Auto Evolution Trigger

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  evolution_cycle:
    name: "üß¨ Ciclo Unificado JARVIS"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üì¶ Instalar Depend√™ncias
        run: pip install sqlmodel pydantic requests

      - name: üß† Orquestrador de Fluxo
        id: flow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          python - << 'PYCODE'
          import os, sys, re
          try:
              from app.application.services.auto_evolutionV2 import AutoEvolutionServiceV2
              auto = AutoEvolutionServiceV2()
              
              # %B captura o corpo completo da mensagem, essencial para Merges
              last_msg = os.popen("git log -1 --pretty=%B").read()
              last_auth = os.popen("git log -1 --pretty=%an").read()
              
              print(f"--- DEBUG INFO ---")
              print(f"Author: {last_auth.strip()}")
              print(f"Message Header: {last_msg.splitlines()[0] if last_msg else ''}")
              print(f"------------------")

              # 1. DEFINI√á√ÉO DE IDENTIDADE
              # Prioridade total para a TAG, independente de quem fez o Merge
              tag_present = "[Auto-Evolution]" in last_msg
              is_sync_commit = "Inventory Synchronized" in last_msg

              # CASO A: Trava de Seguran√ßa (Evita o loop infinito do pr√≥prio bot)
              if is_sync_commit:
                  print("üõ°Ô∏è Trava Anti-Loop: Invent√°rio sincronizado. Encerrando ciclo.")
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write("action=idle\n")
                  sys.exit(0)

              # CASO B: Encontrou a TAG mas n√£o √© o commit de sincronia (√â um Merge de c√≥digo!)
              elif tag_present:
                  print("üéØ Tag de evolu√ß√£o detectada. Sincronizando invent√°rio JSON...")
                  # Tenta extrair o ID da miss√£o (CAP-XXX)
                  match = re.search(r'CAP-\d+', last_msg)
                  if match:
                      cap_id = match.group()
                      print(f"‚úÖ Marcando miss√£o {cap_id} como completa no DNA...")
                      if auto.mark_mission_as_completed(cap_id):
                          os.system("git config --global user.name 'Jarvis-AutoEvolution'")
                          os.system("git config --global user.email 'jarvis@bot.com'")
                          os.system("git add data/capabilities.json")
                          # A mensagem abaixo garante o CASO A na pr√≥xima execu√ß√£o
                          os.system(f"git commit -m '[Auto-Evolution] Inventory Synchronized ‚úÖ for {cap_id}' || echo 'No changes'")
                          os.system("git push origin main")
                  
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write("action=sync_only\n")
                  sys.exit(0)

              # CASO C: Fluxo padr√£o (Commits humanos sem tag de auto-evolu√ß√£o)
              else:
                  print("üöÄ Detectado commit humano. Buscando pr√≥xima evolu√ß√£o...")
                  next_m = auto.find_next_mission()
                  if next_m:
                      cap_id = next_m['id']
                      # Checa se j√° existe PR aberta para esse ID
                      pr_check = os.popen(f'gh pr list --search "{cap_id}" --state open --json title').read()
                      
                      if len(pr_check.strip()) > 5:
                          print(f"‚ö†Ô∏è PR para {cap_id} j√° est√° aberta. Aguardando Merge.")
                          action = "wait"
                      else:
                          with open('mission_context.txt', 'w', encoding='utf-8') as f:
                              f.write(auto.get_roadmap_context(next_m))
                          action = "evolve"
                          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                              f.write(f"mission_desc={cap_id}: {next_m['title']}\n")
                  else:
                      print("‚úÖ Todas as miss√µes do roadmap foram conclu√≠das.")
                      action = "idle"
                  
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f"action={action}\n")

          except Exception as e:
              print(f"‚ùå Erro Cr√≠tico no Orquestrador: {e}")
              sys.exit(1)
          PYCODE

      - name: ü§ñ Executar Muta√ß√£o de DNA
        if: steps.flow.outputs.action == 'evolve'
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_BODY: ${{ steps.flow.outputs.mission_desc }}
        run: |
          git config --global user.name "Jarvis-AutoEvolution"
          git config --global user.email "jarvis@bot.com"
          BRANCH_NAME="auto-evolution/mission-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$(pwd)"
          
          python scripts/evolution_mutator.py \
            --strategy "minimal_change" \
            --intent "auto-evolution-mission" \
            --impact "functional-improvement" \
            --roadmap-context "$(cat mission_context.txt)"
          
          git add -A
          if [ -n "$(git status --porcelain)" ]; then
            # Inclu√≠mos o ISSUE_BODY no t√≠tulo para garantir que o CAP-ID esteja no commit
            git commit -m "[Auto-Evolution] DNA Mutated: $ISSUE_BODY"
            git push origin "$BRANCH_NAME"
            gh pr create --title "üß¨ Evolu√ß√£o: $ISSUE_BODY" \
                         --body "Implementa√ß√£o autom√°tica baseada no invent√°rio JSON." \
                         --base main --head "$BRANCH_NAME"
          else
            echo "Nenhuma mudan√ßa de DNA detectada."
          fi
