name: "ğŸ’ JARVIS: Crystallizer"

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'data/capabilities.json'
      - 'app/domain/**'
      - 'app/application/services/**'

jobs:
  organize:
    name: "ğŸ’ Ciclo de CristalizaÃ§Ã£o DNA"
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›°ï¸ Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GIT_PAT }}
          fetch-depth: 0

      - name: ğŸ“¦ Setup UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: '3.11'

      - name: ğŸ§  Run Crystallizer Engine (Full Cycle)
        env:
          PYTHONPATH: ${{ github.workspace }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          uv venv --clear --python 3.11
          uv pip install requests sqlmodel pydantic python-dotenv
          
          uv run python - << 'PYCODE'
          import sys
          from app.application.services.crystallization.crystallizer_engine import CrystallizerEngine
          
          try:
              print("ğŸ’ Iniciando Full Cycle do Crystallizer Engine...")
              engine = CrystallizerEngine()
              engine.run_full_cycle()
              print("âœ¨ CristalizaÃ§Ã£o concluÃ­da.")
          except Exception as e:
              print(f"âŒ Erro: {e}")
              sys.exit(1)
          PYCODE
          
      - name: ğŸ”„ Sync DNA Map & Containers
        env:
          TOKEN: ${{ secrets.GIT_PAT }}
        run: |
          git config --global user.name "Jarvis-Crystallizer"
          git config --global user.email "jarvis@bot.com"
          
          # 1. Reconfigura URL para garantir permissÃ£o
          git remote set-url origin https://x-access-token:${TOKEN}@github.com/${{ github.repository }}.git
          
          # 2. Adiciona as mudanÃ§as
          git add data/master_crystal.json app/application/containers/*.py
          
          # 3. Se houver mudanÃ§as, faz o commit ANTES do pull
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "chore: [Crystallizer] DNA Mapping & Container Synchronization [Auto-Cura]"
            
            # 4. Agora sim, puxamos as mudanÃ§as do servidor integrando com as nossas
            # O rebase agora funciona porque o nosso 'trabalho' jÃ¡ estÃ¡ commitado localmente
            git pull origin main --rebase
            
            # 5. Push final
            git push origin main
          else
            echo "âœ… DNA jÃ¡ estÃ¡ sincronizado e estÃ¡vel."
          fi
