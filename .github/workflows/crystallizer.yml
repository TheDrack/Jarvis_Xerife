name: "ğŸ’ JARVIS: Crystallizer"

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'data/capabilities.json'
      - 'app/domain/**'
      - 'app/application/services/**'

jobs:
  organize:
    name: "ğŸ’ Ciclo de CristalizaÃ§Ã£o DNA"
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›°ï¸ Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GIT_PAT }}
          fetch-depth: 0

      - name: ğŸ“¦ Setup UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: '3.11'

      - name: ğŸ—ï¸ Prepare Environment & Structural Crystallization
        run: |
          uv venv --clear --python 3.11
          # Instalando dependÃªncias bÃ¡sicas para os scripts de manutenÃ§Ã£o
          uv pip install requests sqlmodel pydantic python-dotenv
          
          echo "ğŸ› ï¸ Rodando Sanidade Estrutural (__init__.py e Classes)..."
          uv run python scripts/cristalize_project.py

      - name: ğŸ§  Run Crystallizer Engine (Full Cycle)
        env:
          PYTHONPATH: ${{ github.workspace }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          uv run python - << 'PYCODE'
          import sys
          import os
          # Adiciona o workspace ao path para garantir que o Nexus encontre tudo
          sys.path.append(os.getcwd())
          
          from app.application.services.crystallization.crystallizer_engine import CrystallizerEngine
          
          try:
              print("ğŸ’ Iniciando Full Cycle do Crystallizer Engine...")
              engine = CrystallizerEngine()
              engine.run_full_cycle()
              print("âœ¨ CristalizaÃ§Ã£o lÃ³gica concluÃ­da.")
          except Exception as e:
              print(f"âŒ Erro: {e}")
              sys.exit(1)
          PYCODE
          
      - name: ğŸ”„ Sync DNA Map & Containers
        env:
          TOKEN: ${{ secrets.GIT_PAT }}
        run: |
          git config --global user.name "Jarvis-Crystallizer"
          git config --global user.email "jarvis@bot.com"
          
          git remote set-url origin https://x-access-token:${TOKEN}@github.com/${{ github.repository }}.git
          
          # 1. Adiciona mudanÃ§as estruturais (feitos pelo script de cristalizaÃ§Ã£o)
          # 2. Adiciona mudanÃ§as de lÃ³gica (feitos pelo Engine)
          git add .
          
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "chore: [Crystallizer] DNA Mapping & Structural Synchronization [Auto-Cura]"
            git pull origin main --rebase
            git push origin main
          else
            echo "âœ… DNA e Estrutura jÃ¡ estÃ£o sincronizados e estÃ¡veis."
          fi
