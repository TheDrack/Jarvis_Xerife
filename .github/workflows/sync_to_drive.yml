name: Sync JARVIS to Google Drive
on:
  push:
    branches: [ main ]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Create ZIP
        run: zip -r Jarvis_Xerife-main.zip . -x "*.git*" "venv/*" "__pycache__/*"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib

      - name: Upload to Drive
        shell: python
        env:
          G_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          DRIVE_FOLDER_ID: ${{ secrets.DRIVE_FOLDER_ID }}
        run: |
          import os, json
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload

          # Carrega dados do ambiente
          try:
              info = json.loads(os.environ['G_JSON'])
              folder_id = os.environ['DRIVE_FOLDER_ID']
              
              creds = service_account.Credentials.from_service_account_info(
                  info, scopes=['https://www.googleapis.com/auth/drive.file']
              )
              service = build('drive', 'v3', credentials=creds)

              file_name = 'Jarvis_Xerife-main.zip'
              media = MediaFileUpload(file_name, mimetype='application/zip')
              
              # Busca arquivo existente
              q = f"name='{file_name}' and '{folder_id}' in parents and trashed = false"
              results = service.files().list(q=q, fields="files(id)").execute()
              files = results.get('files', [])

              if files:
                  file_id = files[0]['id']
                  service.files().update(fileId=file_id, media_body=media).execute()
                  print(f"Sincronização concluída: Arquivo {file_id} atualizado.")
              else:
                  file_metadata = {'name': file_name, 'parents': [folder_id]}
                  file = service.files().create(body=file_metadata, media_body=media, fields='id').execute()
                  print(f"Sincronização concluída: Novo arquivo criado com ID {file.get('id')}.")
          except Exception as e:
              print(f"Erro na simbiose: {str(e)}")
              exit(1)
