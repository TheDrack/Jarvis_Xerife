import os
import re
import sys

class ProjectCrystallizer:
    def __init__(self):
        self.base_path = "./app"
        self.ignore_files = ["__init__.py", "nexus.py"]

    def _to_pascal_case(self, name: str) -> str:
        return "".join(word.capitalize() for word in name.split("_"))

    def crystallize(self):
        print("ðŸ’Ž [CRISTALIZADOR] Iniciando CicatrizaÃ§Ã£o Inteligente...")
        
        for root, _, files in os.walk(self.base_path):
            if "__init__.py" not in files:
                with open(os.path.join(root, "__init__.py"), "w", encoding="utf-8") as f:
                    f.write("# Auto-generated by JARVIS\n")

            for file in files:
                if file.endswith(".py") and file not in self.ignore_files:
                    self._fix_file(os.path.join(root, file), file[:-3])

        print("âœ… [CRISTALIZADOR] Estrutura estabilizada.")

    def _fix_file(self, file_path, file_id):
        expected_class = self._to_pascal_case(file_id)
        
        with open(file_path, "r", encoding="utf-8") as f:
            content = f.read()

        # 1. Busca qualquer classe jÃ¡ existente no arquivo
        class_match = re.search(r"class\s+([a-zA-Z0-9_]+)", content)
        
        if class_match:
            existing_class = class_match.group(1)
            # Se a classe existente for diferente da esperada (ex: PersistentBrowserManager != BrowserManager)
            # NÃ³s criamos um ALIAS no final do arquivo para o Nexus nÃ£o se perder
            if existing_class != expected_class and f"{expected_class} =" not in content:
                print(f"  [ðŸ”—] Criando link: {expected_class} -> {existing_class} em {file_id}.py")
                with open(file_path, "a", encoding="utf-8") as f:
                    f.write(f"\n\n# Alias para compatibilidade Nexus\n{expected_class} = {existing_class}\n")
            return

        # 2. Se nÃ£o houver classe nenhuma, encapsula (Mantendo compatibilidade)
        print(f"  [ðŸ“¦] Envelopando funÃ§Ãµes soltas em: {expected_class}")
        lines = content.split('\n')
        indented = "\n".join([f"    {line}" if line.strip() else line for line in lines])
        
        new_content = (
            f"class {expected_class}:\n"
            f"    def __init__(self, *args, **kwargs):\n"
            f"        pass\n\n"
            f"{indented}\n"
        )
        
        with open(file_path, "w", encoding="utf-8") as f:
            f.write(new_content)

if __name__ == "__main__":
    ProjectCrystallizer().crystallize()
