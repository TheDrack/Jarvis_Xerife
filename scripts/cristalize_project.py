import os
import re
import logging

class ProjectCrystallizer:
    def __init__(self):
        self.base_path = "./app"
        self.ignore_files = ["__init__.py", "nexus.py"]

    def _to_pascal_case(self, name: str) -> str:
        return "".join(word.capitalize() for word in name.split("_"))

    def crystallize(self):
        print("üíé [CRISTALIZADOR] Iniciando interven√ß√£o estrutural...")
        
        for root, _, files in os.walk(self.base_path):
            # 1. Garantir __init__.py
            if "__init__.py" not in files:
                with open(os.path.join(root, "__init__.py"), "w", encoding="utf-8") as f:
                    f.write("# Auto-generated by JARVIS Nexus\n")
                print(f"  [+] Pacote criado: {root}")

            for file in files:
                if file.endswith(".py") and file not in self.ignore_files:
                    self._fix_file_structure(os.path.join(root, file), file[:-3])

        print("‚úÖ [CRISTALIZADOR] Projeto cicatrizado e pronto para o Nexus.")

    def _fix_file_structure(self, file_path, file_id):
        expected_class = self._to_pascal_case(file_id)
        
        with open(file_path, "r", encoding="utf-8") as f:
            content = f.read()

        # Verifica se a classe correta j√° existe
        if f"class {expected_class}" in content:
            return

        print(f"  [üîß] Corrigindo estrutura: {file_id}.py -> class {expected_class}")

        # Se existir uma classe com nome errado, tenta renomear
        # Caso contr√°rio, encapsula o conte√∫do
        class_match = re.search(r"class\s+([a-zA-Z0-9_]+)\b", content)
        
        if class_match:
            old_class = class_match.group(1)
            new_content = content.replace(f"class {old_class}", f"class {expected_class}")
        else:
            # Encapsulamento de fun√ß√µes soltas em um m√©todo 'execute'
            lines = content.split('\n')
            indented_content = "\n".join([f"    {line}" if line.strip() else line for line in lines])
            
            new_content = (
                f"class {expected_class}:\n"
                f"    \"\"\"Classe auto-cristalizada pelo JARVIS\"\"\"\n"
                f"    def __init__(self):\n"
                f"        pass\n\n"
                f"{indented_content}"
            )

        with open(file_path, "w", encoding="utf-8") as f:
            f.write(new_content)

if __name__ == "__main__":
    crystallizer = ProjectCrystallizer()
    crystallizer.crystallize()
